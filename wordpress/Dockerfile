FROM php:8.1-apache

# 1) Install PHP extensions, MySQL client, and tools
RUN apt-get update \
 && apt-get install -y \
      default-mysql-client \
      vim \
      python3 \
      python3-pip \
      libfreetype6-dev \
      libjpeg62-turbo-dev \
      libpng-dev \
      libzip-dev \
      zip \
      unzip \
      git \
      libonig-dev \
      libxml2-dev \
 && docker-php-ext-configure gd --with-freetype --with-jpeg \
 && docker-php-ext-install -j"$(nproc)" \
      mysqli \
      pdo \
      pdo_mysql \
      gd \
      zip \
      opcache \
 && mkdir -p /tmp/pear/temp \
 && chmod -R 0777 /tmp/pear \
 && pecl install redis \
 && docker-php-ext-enable redis \
 && rm -rf /var/lib/apt/lists/*

# 2) Enable Apache modules
RUN a2enmod rewrite headers expires

COPY pete.conf /etc/apache2/sites-available/pete.conf
RUN chmod 644 /etc/apache2/sites-available/pete.conf \
 && a2dissite 000-default.conf \
 && a2ensite pete.conf

# 3) Copy custom php.ini
COPY php.ini /usr/local/etc/php/

# 4) Download & unpack WordPress core
RUN curl -o /tmp/wordpress.tar.gz https://wordpress.org/latest.tar.gz \
 && tar -xzf /tmp/wordpress.tar.gz --strip-components=1 -C /var/www/html \
 && rm /tmp/wordpress.tar.gz \
 && chown -R www-data:www-data /var/www/html

# 5) Set working dir & ensure ownership
WORKDIR /var/www/html
RUN chown -R www-data:www-data /var/www/html

# 6) (Optional) Install WP-CLI
RUN curl -o /usr/local/bin/wp https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar \
 && chmod +x /usr/local/bin/wp

# Silence Apache FQDN warning
RUN echo "ServerName localhost" >> /etc/apache2/apache2.conf

# ðŸ‘‡ Install Composer globally
RUN curl -sS https://getcomposer.org/installer | php \
  && mv composer.phar /usr/local/bin/composer \
  && chmod +x /usr/local/bin/composer

# Copy and set entrypoint script
COPY pete_install.sh /usr/local/bin/pete_install.sh
RUN chmod +x /usr/local/bin/pete_install.sh \
 && chown www-data:www-data /usr/local/bin/pete_install.sh

RUN mkdir -p /var/www/.ssh \
 && chown -R www-data:www-data /var/www

EXPOSE 80

ENTRYPOINT ["/usr/local/bin/pete_install.sh"]
CMD ["apache2-foreground"]
