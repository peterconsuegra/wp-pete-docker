[www]
; =====================================================================
; Pete Panel – PHP-FPM pool (production, 16GB / 4 vCPU host)
; Container: php  (mem_limit ≈ 4096M, cpus ≈ 1.4)
;
; Goal:
;   • ~30 concurrent PHP workers (pm.max_children = 30)
;   • Each worker budget ≈ 80–120MB in practice
;   • Headroom for OPcache, CLI bursts, composer, cron, etc.
; =====================================================================

; --- identity ---
user  = www-data
group = www-data

; --- listen (Apache proxy via :9000) ---
listen = 0.0.0.0:9000
listen.backlog = 256
listen.owner  = www-data
listen.group  = www-data
listen.mode   = 0660

; ================= Process Manager =================
; With ~4GB for php-fpm and WP/Woo typical peak ~80–120MB per worker:
;   30 children × ~100MB ≈ 3GB for workers
;   leaves ~1GB for OPcache, PHP core, CLI tools, cron, etc.
;
; If you see OOM in this container:
;   • drop pm.max_children to 24, or
;   • reduce memory_limit in php.ini.
pm = dynamic

; Maximum PHP workers that can live at once
pm.max_children = 30            ; sweet spot for your 4GB php container

; How many workers to start on boot
pm.start_servers   = 8          ; ≈ 1/4 of max_children for warm pool

; Min/Max idle workers waiting for new requests
pm.min_spare_servers = 8
pm.max_spare_servers = 16       ; avoid over-spawning under short spikes

; Recycle workers periodically to avoid memory leaks in plugins
pm.max_requests = 1500

; --- timeouts / stability ---
; Hard kill any hung request (e.g. bad plugin, remote API stuck).
; Keep this ≥ max_execution_time from php.ini (90s) with some margin.
request_terminate_timeout = 120s

; Log slow requests for debugging performance hotspots
request_slowlog_timeout   = 10s
slowlog = /var/log/php-fpm/slowlog.log

; Optional: how long an idle process may live (default is fine, but explicit):
; pm.process_idle_timeout = 10s

; --- status/health (keep for metrics) ---
pm.status_path = /fpm-status
ping.path      = /fpm-ping

; --- env pass-through (optional) ---
; env[APP_ENV] = production

; --- file/resource limits (match Docker ulimits sanely) ---
; Docker nofile ulimit for php: 131072
; Per-worker 8K FDs is more than enough for WP/Woo.
; Uncomment if you ever hit "too many open files" at pool level:
; rlimit_files = 8192
; rlimit_core  = 0

; --- harden logging at pool level (optional) ---
; php_admin_value[error_log] = /var/log/php/error.log
; php_admin_flag[log_errors] = on
