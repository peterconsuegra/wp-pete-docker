[www]
; =====================================================================
; Pete Panel – PHP-FPM pool (production, 16GB / 4 vCPU host)
; Container: php  (mem_limit ≈ 4096M, cpus ≈ 1.4)
;
; Target:
;   • ~50 RPS on Woo checkout
;   • ~30–36 concurrent PHP workers
;   • Headroom for OPcache, CLI bursts, cron, etc.
; =====================================================================

user  = www-data
group = www-data

; --- listen (Apache proxy via :9000) ---
listen = 0.0.0.0:9000
listen.backlog = 512       ; was 256 – better for short spikes
listen.owner  = www-data
listen.group  = www-data
listen.mode   = 0660

; ================= Process Manager =================
; Assumptions:
;   • PHP container cgroup: ~4GB
;   • Typical Woo request: 80–120MB RSS per worker in practice
;   → 36 workers ≈ ~3–4GB under heavy load (still safe if not
;     ALL are at peak at once).
;
; If you see OOM:
;   • drop pm.max_children back to 30, OR
;   • lower memory_limit in php.ini (e.g. 384M).
pm = dynamic

; Max concurrent PHP workers
pm.max_children = 36

; Warm pool on boot (~1/3 of max_children)
pm.start_servers = 10

; Idle worker bounds
pm.min_spare_servers = 10
pm.max_spare_servers = 18

; Recycle workers periodically to avoid leaks in plugins
pm.max_requests = 1500

; --- timeouts / stability ---
; Keep in sync with php.ini max_execution_time (90s) with some margin.
; Woo checkout should not take >60s in practice.
request_terminate_timeout = 60s

; Log slow requests to identify heavy plugins/queries
request_slowlog_timeout   = 10s
slowlog = /var/log/php-fpm/slowlog.log

; --- status/health (keep for metrics) ---
pm.status_path = /fpm-status
ping.path      = /fpm-ping

; --- env pass-through (optional) ---
; env[APP_ENV] = production

; --- file/resource limits (Docker ulimit: nofile=131072) ---
; Per-worker 8K FDs is huge; uncomment if you ever hit "too many open files":
; rlimit_files = 8192
; rlimit_core  = 0

; --- pool-level logging (optional) ---
; php_admin_value[error_log] = /var/log/php/error.log
; php_admin_flag[log_errors] = on