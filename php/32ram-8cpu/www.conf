;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Pete Panel – PHP-FPM www pool (high-throughput WooCommerce)
; Host: Hetzner CCX33 (32GB / 8 vCPU)
; PHP container: ~16GB RAM, ~4–5 vCPU
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

[www]
user  = www-data
group = www-data

; TCP listener (matches cachetool + Apache config)
listen = 0.0.0.0:9000
listen.backlog = 4096
listen.owner = www-data
listen.group = www-data
listen.mode  = 0660

clear_env = no

; =======================
; Process Manager
; =======================
pm = dynamic

; With 512M limit, real RSS is typically 80–130MB/child.
; 128 children keeps ~11–13GB usable for PHP while leaving safety headroom.
pm.max_children = 160

; Warm pool for checkout bursts
pm.start_servers = 24
pm.min_spare_servers = 24
pm.max_spare_servers = 64

; Fast ramp-up under sudden load
pm.max_spawn_rate = 32

; Recycle workers to prevent RSS creep from Woo hooks/plugins
pm.max_requests = 600

; =======================
; Timeouts & guards
; =======================
; Payment gateways can be slow under load
request_terminate_timeout = 90s
request_slowlog_timeout   = 4s
pm.process_idle_timeout   = 15s

; =======================
; Logging
; =======================
php_admin_flag[log_errors] = on
php_admin_value[error_log] = /var/log/php-fpm/error.log
slowlog = /var/log/php-fpm/slow.log
catch_workers_output = yes

; Access log useful during tuning, disable later if needed
access.format = "%R - %u %t \"%m %r%Q%q\" %s %f %{milli}dms %{kilo}Mkb"

; =======================
; Resource limits
; =======================
; Match container ulimits
rlimit_files = 131072

; =======================
; Monitoring (recommended)
; =======================
pm.status_path = /fpm-status
ping.path = /fpm-ping
ping.response = pong

; =======================
; PHP admin overrides
; =======================
php_admin_value[session.save_path] = /tmp
php_admin_value[opcache.error_log] = /var/log/php-fpm/opcache.log

php_admin_value[post_max_size] = 128M
php_admin_value[upload_max_filesize] = 128M

; =======================
; Environment
; =======================
env[APP_ENV] = production
env[PETE_ENVIRONMENT] = production