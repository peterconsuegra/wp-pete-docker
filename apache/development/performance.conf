#######################################################################
# Apache performance (DEV) – 4GB RAM / 4 vCPU / PHP-FPM behind proxy_fcgi
# Notes:
# - PHP concurrency is ultimately capped by PHP-FPM (pm.max_children=24).
# - Apache can serve many static requests concurrently; keep headroom.
#######################################################################

# --- Core timeouts (dev-friendly, avoid long hangs) ---
Timeout             120
CGIDScriptTimeout   120

# Docker/overlayfs friendly: avoid sendfile/mmap issues
EnableSendfile Off
EnableMMAP     Off

#######################################################################
# 1) MPM-event – concurrency & keep-alive
#######################################################################
<IfModule mpm_event_module>
    # With 4 vCPU, 2 children is plenty for dev; 4 gives static headroom.
    ServerLimit            4
    StartServers           2

    # 64 threads/child is a good balance; 4 * 64 = 256 MaxRequestWorkers
    ThreadsPerChild        64
    MaxRequestWorkers      256

    # Keep enough idle threads to absorb small bursts
    MinSpareThreads        64
    MaxSpareThreads        128

    # Recycle to avoid memory creep during long dev sessions
    MaxConnectionsPerChild 2000

    # Keep-Alive: low timeout keeps threads free; enough requests per conn
    KeepAlive On
    KeepAliveTimeout 2
    MaxKeepAliveRequests 200
</IfModule>

#######################################################################
# 2) Core server tweaks
#######################################################################
ServerTokens Prod
ServerSignature Off

# Make ETags stable and simple in containers
FileETag MTime Size

#######################################################################
# 3) HTTP/2
#######################################################################
Protocols h2 http/1.1
# HTTP/2 Server Push is deprecated in browsers; keep it off.
H2Push off

#######################################################################
# 4) Compression – gzip / deflate
#######################################################################
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE \
        text/html text/plain text/css text/xml text/javascript \
        application/javascript application/json image/svg+xml
</IfModule>

#######################################################################
# 5) Disk Cache (opt-in by vhost; keep path consistent with container)
#######################################################################
<IfModule mod_cache_disk.c>
    CacheRoot /var/cache/apache2/mod_cache_disk
    # Optional dev-friendly limits (uncomment if you enable caching in vhost)
    # CacheDirLength 2
    # CacheDirLevels  1
    # CacheMaxFileSize 10485760
    # CacheQuickHandler off
</IfModule>

#######################################################################
# 6) ModSecurity – skip rules on static files to save CPU
#######################################################################
<IfModule security2_module>
  <LocationMatch "\.(?:ico|gif|jpe?g|png|svg|css|js|woff2?)$">
      SecRuleEngine Off
  </LocationMatch>
</IfModule>

#######################################################################
# 7) Proxy / FPM niceties (safe defaults; keep stricter in vhost if needed)
#######################################################################
<IfModule proxy_module>
  ProxyRequests Off
  ProxyBadHeader Ignore
  ProxyTimeout 120
</IfModule>

# Recommended when proxying to php-fpm to avoid chunking edge cases in dev
<IfModule proxy_http_module>
  ProxyErrorOverride Off
</IfModule>
