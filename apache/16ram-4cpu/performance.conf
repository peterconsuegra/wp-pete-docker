#######################################################################
# Pete Panel – Apache perf profile
# Host: Hetzner CCX23 (16 GB / 4 vCPU)
# Container: apache (mem_limit ≈ 3072M, cpus ≈ 1.4)
#
# Goal:
#   • Serve ~10,000 cached page hits/minute (≈ 170 req/s)
#   • Use mpm_event for high concurrency without starving PHP-FPM
#   • Keep memory predictable with ModSecurity + HTTP/2 enabled
#######################################################################

#######################################################################
# 0) Global safety timeouts (prod)
#######################################################################
Timeout 30
RequestReadTimeout header=20-40,MinRate=500 body=20,MinRate=500

# Files on Docker volumes can misbehave with sendfile/MMAP → avoid bugs.
EnableSendfile Off
EnableMMAP     Off

#######################################################################
# 1) MPM Event — tuned for 1.4 CPU / ~3 GB Apache container
#    Notes:
#      • PHP-FPM pm.max_children ≈ 30 in the php container.
#      • Apache is allowed to have more workers because most requests
#        hit cached/static content and return quickly.
#######################################################################
<IfModule mpm_event_module>
    StartServers              2

    # 4 children × 64 threads = 256 MaxRequestWorkers
    # Plenty for H2 concurrency and 10k/min loader tests,
    # while keeping RSS under control with ModSecurity enabled.
    ServerLimit               4
    ThreadsPerChild          64
    MaxRequestWorkers       256

    MinSpareThreads          64
    MaxSpareThreads         128

    MaxConnectionsPerChild 10000

    # KeepAlive: aggressive but safe for high concurrency
    KeepAlive On
    KeepAliveTimeout 1
    MaxKeepAliveRequests 200
</IfModule>

#######################################################################
# 2) Core server hardening & small wins
#######################################################################
ServerTokens Prod
ServerSignature Off
TraceEnable Off
FileETag MTime Size

#######################################################################
# 3) HTTP/2 tuning (server push is deprecated → keep it off)
#######################################################################
Protocols h2 http/1.1
ProtocolsHonorOrder On

# Reasonable defaults for Woo + many small assets on 1.4 vCPU
H2MaxSessionStreams  80
H2StreamMaxMemSize   262144
H2WindowSize         6291456

#######################################################################
# 4) Compression (gzip; Brotli if module is present)
#######################################################################
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE \
    text/html text/plain text/css text/xml text/javascript \
    application/javascript application/json application/xml \
    image/svg+xml
  # Don’t waste CPU compressing already-compressed types
  SetEnvIfNoCase Request_URI "\.(?:gif|jpe?g|png|webp|avif|ico|pdf|zip|gz|bz2|7z|mp4|mp3|woff2?)$" no-gzip
</IfModule>

<IfModule brotli_module>
  BrotliCompressionQuality 5
  AddOutputFilterByType BROTLI_COMPRESS \
    text/html text/plain text/css text_xml text/javascript \
    application/javascript application/json application_xml \
    image/svg+xml
</IfModule>

#######################################################################
# 5) Far-future caching for static assets (client-side cache)
#######################################################################
<IfModule mod_expires.c>
  ExpiresActive On
  # cache static forever (rev via querystring or file name hashing)
  ExpiresByType text/css                   "access plus 1 year"
  ExpiresByType application/javascript     "access plus 1 year"
  ExpiresByType image/svg+xml              "access plus 1 year"
  ExpiresByType image/avif                 "access plus 1 year"
  ExpiresByType image/webp                 "access plus 1 year"
  ExpiresByType image/png                  "access plus 1 year"
  ExpiresByType image/jpeg                 "access plus 1 year"
  ExpiresByType image/gif                  "access plus 1 year"
  ExpiresByType font/woff2                 "access plus 1 year"
  ExpiresDefault                           "access plus 1 month"
</IfModule>

<IfModule mod_headers.c>
  <FilesMatch "\.(?:css|js|svg|avif|webp|png|jpe?g|gif|woff2?)$">
    Header unset ETag
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
</IfModule>


#######################################################################
# 6) ModSecurity — skip rules for static to save CPU
#######################################################################
<IfModule security2_module>
  <LocationMatch "\.(?:ico|gif|jpe?g|png|svg|avif|webp|css|js|woff2?)$">
    SecRuleEngine Off
  </LocationMatch>
</IfModule>

#######################################################################
# 7) Small DoS safety valves (cheap protections)
#######################################################################
<IfModule mod_reqtimeout.c>
  RequestReadTimeout header=20-40,MinRate=500 body=20,MinRate=500
</IfModule>

<IfModule mod_ratelimit.c>
  # Example (disabled by default). Uncomment to throttle huge downloads:
  # <LocationMatch "\.(?:zip|tar|gz|bz2|7z|mp4)$">
  #   SetOutputFilter RATE_LIMIT
  #   SetEnv rate-limit 512
  # </LocationMatch>
</IfModule>
