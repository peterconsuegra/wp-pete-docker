# =====================================================================
# Pete Panel – ModSecurity whitelist (balanced)
#   - Keep ModSecurity ON
#   - Surgical removals for WordPress/Woo basics
#   - Option B: remove OWASP CRS tags only for authenticated WRITE
#     requests on admin/REST scopes (safer than engine OFF)
# =====================================================================

###############################################################################
# GLOBAL: If WordPress user is authenticated, disable ModSecurity completely
# Triggers if any of: wordpress_logged_in_* cookie, X-WP-Nonce header, or Authorization
###############################################################################

###############################################################################
# SAFER: Only disable engine for authenticated admin/REST scopes
###############################################################################

# Auth signals
SecRule REQUEST_COOKIES_NAMES "@rx ^wordpress_logged_in_" \
  "id:701000,phase:1,pass,nolog,setvar:tx.wp_auth=1"
SecRule REQUEST_HEADERS:X-WP-Nonce "!@streq ''" \
  "id:701001,phase:1,pass,nolog,setvar:tx.wp_auth=1"
SecRule REQUEST_HEADERS:Authorization "^(?:Basic|Bearer)\\s" \
  "id:701002,phase:1,pass,nolog,setvar:tx.wp_auth=1"

# Scope: wp-admin/*
SecRule TX:wp_auth "@eq 1" \
  "id:701010,phase:1,pass,nolog,chain"
  SecRule REQUEST_URI "@rx ^/wp-admin/" \
    "t:none,ctl:requestBodyAccess=Off,ctl:ruleEngine=Off"

# Scope: /wp-json/*
SecRule TX:wp_auth "@eq 1" \
  "id:701011,phase:1,pass,nolog,chain"
  SecRule REQUEST_URI "@rx ^/wp-json/" \
    "t:none,ctl:requestBodyAccess=Off,ctl:ruleEngine=Off"

# Scope: index.php?rest_route=...
SecRule TX:wp_auth "@eq 1" \
  "id:701012,phase:1,pass,nolog,chain"
  SecRule REQUEST_BASENAME "@streq index.php" "t:none,chain"
  SecRule QUERY_STRING "@contains rest_route=" \
    "t:none,ctl:requestBodyAccess=Off,ctl:ruleEngine=Off"

# Allow methods beyond defaults (Woo/REST often use more than GET/POST)
SecAction \
 "id:1000112,phase:1,pass,nolog,t:none,setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT PATCH DELETE'"

###############################################################################
# 3) PETE PANEL INTERNAL PATHS (ENGINE OFF – SAFE, LOCAL ADMIN ONLY)
###############################################################################
SecRule REQUEST_URI "@beginsWith /admin/phpinfo"          "id:1000002,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /admin/phpinfo/view"     "id:1000003,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /validate-pete"          "id:1000004,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /pete_plugins_install"   "id:1000005,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /pete_update"            "id:1000006,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /update_post"            "id:1000007,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /phpmyadmin"             "id:1000008,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /phpmyinfo"              "id:1000009,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "^/app[0-9]+/update_post$"            "id:1000010,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /internal-certbot"       "id:1000011,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /internal-reload"        "id:1000012,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /pete_plugins"           "id:1000013,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /oupdates"               "id:1000014,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /wp_plugins"             "id:1000015,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /pete_installers"        "id:1000016,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /wp_global_options"      "id:1000017,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /validate_site_json"     "id:1000018,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /wp-json/pete/v1"        "id:1000019,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /plugins"                "id:1000020,phase:1,pass,nolog,ctl:ruleEngine=Off"

