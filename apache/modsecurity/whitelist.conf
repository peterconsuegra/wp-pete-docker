# =====================================================================
# Pete Panel – ModSecurity whitelist (surgical false-positive fixes)
# NOTE: Keep comments OUTSIDE quoted action lists. No backslashes inside quotes.
# =====================================================================

# -----------------------------
# Baseline FP removals (global)
# -----------------------------

SecRule REQUEST_URI "@rx ^/wp-json/" \
  "id:1100198,phase:1,pass,nolog,\
   chain"
  SecRule REQUEST_HEADERS_NAMES "@contains x-http-method-override" \
    "t:none,ctl:ruleRemoveById=920450"

# b) index.php?rest_route=... form (percent-encoded route like %2Fwp%2Fv2%2F...)
SecRule REQUEST_BASENAME "@streq index.php" \
  "id:1100199,phase:1,pass,nolog,chain"
  SecRule QUERY_STRING "@rx (^|&)rest_route=%2Fwp%2F" \
    "t:none,chain"
  SecRule REQUEST_HEADERS_NAMES "@contains x-http-method-override" \
    "t:none,ctl:ruleRemoveById=920450"

SecAction \
  "id:10000,phase:1,pass,nolog,\
   ctl:ruleRemoveById=953100,\
   ctl:ruleRemoveById=959100,\
   ctl:ruleRemoveById=980170"

# -----------------------------
# Pete internal paths (engine off)
# -----------------------------
SecRule REQUEST_URI "@beginsWith /wp-admin" \
  "id:1000001,phase:1,pass,nolog,ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /admin/phpinfo" \
  "id:1000002,phase:1,pass,nolog,ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /admin/phpinfo/view" \
  "id:1000003,phase:1,pass,nolog,ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /validate-pete" \
  "id:1000004,phase:1,pass,nolog,ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /pete_plugins_install" \
  "id:1000005,phase:1,pass,nolog,ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /pete_update" \
  "id:1000006,phase:1,pass,nolog,ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /update_post" \
  "id:1000007,phase:1,pass,nolog,ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /phpmyadmin" \
  "id:1000008,phase:1,pass,nolog,ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /phpmyinfo" \
  "id:1000009,phase:1,pass,nolog,ctl:ruleEngine=Off"

SecRule REQUEST_URI "^/app[0-9]+/update_post$" \
  "id:1000010,phase:1,pass,nolog,ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /internal-certbot" \
  "id:1000011,phase:1,pass,nolog,ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /internal-reload" \
  "id:1000012,phase:1,pass,nolog,ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /pete_plugins" \
  "id:10000011,phase:1,pass,nolog,ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /oupdates" \
  "id:10000012,phase:1,pass,nolog,ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /wp_plugins" \
  "id:10000013,phase:1,pass,nolog,ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /pete_installers" \
  "id:10000014,phase:1,pass,nolog,ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /wp_global_options" \
  "id:10000015,phase:1,pass,nolog,ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /validate_site_json" \
  "id:10000016,phase:1,pass,nolog,ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /wp-json/pete/v1" \
  "id:10000017,phase:1,pass,nolog,ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /plugins" \
  "id:10000018,phase:1,pass,nolog,ctl:ruleEngine=Off"

# Pete dashboard rule (example specific)
SecRule REQUEST_URI "@beginsWith /wordpress-importer" \
  "id:910004,phase:1,pass,nolog,ctl:ruleRemoveById=200004"

# -----------------------------
# WooCommerce allow-list
# -----------------------------

# Engine off for Woo AJAX endpoints (?wc-ajax=...)
SecRule QUERY_STRING "@contains wc-ajax=" \
  "id:1000100,phase:1,pass,nolog,ctl:ruleEngine=Off"

# Engine off for admin-ajax.php (some WC add-ons)
SecRule REQUEST_URI "@endsWith /wp-admin/admin-ajax.php" \
  "id:1000101,phase:1,pass,nolog,ctl:ruleEngine=Off"

# Engine off for legacy wc-api callbacks
SecRule QUERY_STRING "@contains wc-api=" \
  "id:1000102,phase:1,pass,nolog,ctl:ruleEngine=Off"

# Surgical relaxations for specific wc-ajax actions
SecRule QUERY_STRING "@rx \bwc-ajax=(update_order_review|checkout|apply_coupon|get_cart_totals)\b" \
  "id:1000110,phase:1,pass,nolog,ctl:ruleRemoveById=942100,ctl:ruleRemoveById=942110,ctl:ruleRemoveById=941100,ctl:ruleRemoveById=941160,ctl:ruleRemoveById=930120,ctl:ruleRemoveById=942430"

# Surgical relaxations for wc-api payloads
SecRule QUERY_STRING "@rx \bwc-api=\w+" \
  "id:1000111,phase:1,pass,nolog,ctl:ruleRemoveById=942100,ctl:ruleRemoveById=942110,ctl:ruleRemoveById=941100,ctl:ruleRemoveById=941160"

# Allow methods beyond defaults
SecAction \
 "id:1000112,phase:1,pass,nolog,t:none,setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT PATCH DELETE'"

# -----------------------------
# Core WordPress relaxations
# -----------------------------

# Admin AJAX – keep engine ON but remove noisy CRS rules
SecRule REQUEST_URI "@endsWith /wp-admin/admin-ajax.php" \
  "id:1100100,phase:1,pass,nolog,ctl:ruleRemoveById=941100,ctl:ruleRemoveById=941160,ctl:ruleRemoveById=942100,ctl:ruleRemoveById=942110,ctl:ruleRemoveById=942430"

# Heartbeat (quieter editing)
SecRule REQUEST_URI "@endsWith /wp-admin/admin-ajax.php" "id:1100101,phase:1,pass,nolog,chain"
  SecRule ARGS:action "@streq heartbeat" "t:none,ctl:ruleEngine=Off"

SecRule REQUEST_URI "@rx ^/wp-json/" \
  "id:1100200,phase:1,pass,nolog,\
   ctl:ruleRemoveTargetById=920450;REQUEST_HEADERS:X-HTTP-Method-Override,\
   ctl:ruleRemoveTargetById=920450;REQUEST_HEADERS_NAMES,\
   ctl:ruleRemoveById=920450"

SecRule REQUEST_URI "@rx ^/index\.php$" "id:1100201,phase:1,pass,nolog,chain"
  SecRule QUERY_STRING "@rx (^|&)rest_route=%2Fwp%2F" "t:none,\
   ctl:ruleRemoveTargetById=920450;REQUEST_HEADERS:X-HTTP-Method-Override,\
   ctl:ruleRemoveTargetById=920450;REQUEST_HEADERS_NAMES,\
   ctl:ruleRemoveById=920450"

# REST writes – relax only content-like fields
SecRule REQUEST_URI "@rx ^/(wp-json/|index\.php$)" "id:1100202,phase:2,pass,nolog,chain"
  SecRule REQUEST_METHOD "@pm POST PUT PATCH" "t:none,chain"
  SecRule &REQUEST_HEADERS:Content-Type "@ge 1" "t:none,ctl:ruleRemoveTargetById=941100;ARGS:content,ctl:ruleRemoveTargetById=941160;ARGS:content,ctl:ruleRemoveTargetById=942100;ARGS:content,ctl:ruleRemoveTargetById=942110;ARGS:content,ctl:ruleRemoveTargetById=941100;ARGS:excerpt,ctl:ruleRemoveTargetById=942100;ARGS:excerpt,ctl:ruleRemoveTargetById=941100;ARGS:blocks,ctl:ruleRemoveTargetById=942100;ARGS:blocks"

# Media Library uploads
SecRule REQUEST_URI "@endsWith /wp-admin/async-upload.php" \
  "id:1100300,phase:1,pass,nolog,ctl:ruleRemoveById=941100,ctl:ruleRemoveById=941160,ctl:ruleRemoveById=942100,ctl:ruleRemoveById=942110,ctl:ruleRemoveById=930120"
# ^ file path access relaxation included

# Search (?s=) – avoid SQLi FPs on natural queries
SecRule &ARGS:s "@ge 1" \
  "id:1100400,phase:1,pass,nolog,ctl:ruleRemoveTargetById=942100;ARGS:s,ctl:ruleRemoveTargetById=942110;ARGS:s,ctl:ruleRemoveTargetById=942430;ARGS:s"

# Preview & Customizer – long/b64 content
SecRule REQUEST_URI "@endsWith /wp-admin/post.php" "id:1100500,phase:1,pass,nolog,chain"
  SecRule ARGS:preview "@streq true" "t:none,ctl:ruleRemoveTargetById=941100;ARGS:content,ctl:ruleRemoveTargetById=942100;ARGS:content"

SecRule REQUEST_URI "@endsWith /wp-admin/customize.php" \
  "id:1100501,phase:1,pass,nolog,ctl:ruleRemoveTargetById=941100;ARGS,ctl:ruleRemoveTargetById=942100;ARGS"

# Optional: wp-cron (usually internal)
SecRule REQUEST_URI "@endsWith /wp-cron.php" \
  "id:1100600,phase:1,pass,nolog,ctl:ruleEngine=Off"

# -----------------------------
# Popular plugins/builders
# -----------------------------

# WooCommerce extras (surgical, REST/admin-ajax variants handled above)
SecRule REQUEST_URI "@contains /wc-api/" \
  "id:1200100,phase:1,pass,nolog,ctl:ruleRemoveById=941100,ctl:ruleRemoveById=941160,ctl:ruleRemoveById=942100,ctl:ruleRemoveById=942110"

# Contact Form 7 (admin-ajax)
SecRule REQUEST_URI "@endsWith /wp-admin/admin-ajax.php" "id:1200200,phase:1,pass,nolog,chain"
  SecRule ARGS:action "@rx ^wpcf7|contact\-form\-7" "t:none,ctl:ruleRemoveById=941100,ctl:ruleRemoveById=941160,ctl:ruleRemoveById=942100,ctl:ruleRemoveById=942110"

# Elementor (REST + admin-ajax)
SecRule REQUEST_URI "@rx ^/wp-json/elementor/v1/" \
  "id:1200300,phase:1,pass,nolog,ctl:ruleRemoveById=941100,ctl:ruleRemoveById=942100"

SecRule REQUEST_URI "@endsWith /wp-admin/admin-ajax.php" "id:1200301,phase:1,pass,nolog,chain"
  SecRule ARGS:action "@rx ^elementor_" "t:none,ctl:ruleRemoveById=941100,ctl:ruleRemoveById=942100"

# Divi Builder (admin-ajax)
SecRule REQUEST_URI "@endsWith /wp-admin/admin-ajax.php" "id:1200400,phase:1,pass,nolog,chain"
  SecRule ARGS:action "@contains et_fb_" "t:none,ctl:ruleRemoveById=941100,ctl:ruleRemoveById=942100"

# Yoast SEO (REST)
SecRule REQUEST_URI "@rx ^/wp-json/yoast/v1/" \
  "id:1200500,phase:1,pass,nolog,ctl:ruleRemoveById=941100,ctl:ruleRemoveById=942100"

# Query Monitor (REST + admin-ajax)
SecRule REQUEST_URI "@rx ^/wp-json/qm/" \
  "id:1200600,phase:1,pass,nolog,ctl:ruleRemoveById=941100,ctl:ruleRemoveById=942100"

SecRule REQUEST_URI "@endsWith /wp-admin/admin-ajax.php" "id:1200601,phase:1,pass,nolog,chain"
  SecRule ARGS:action "@streq query-monitor" "t:none,ctl:ruleRemoveById=941100,ctl:ruleRemoveById=942100"


# Gutenberg Templates / Template Parts saves (JSON) – relax noisy rules only on content-like fields
# Also relax REQUEST_BODY to cover large block JSON that still trips 9322xx/9411xx.

# Native /wp-json/... form
SecRule REQUEST_URI "@rx ^/wp-json/wp/v2/(templates|template-parts)(/|$)" \
  "id:1100210,phase:2,pass,nolog,chain"
  SecRule REQUEST_METHOD "@pm POST PUT PATCH" "t:none,chain"
    SecRule &REQUEST_HEADERS:Content-Type "@ge 1" "t:none,\
     ctl:ruleRemoveTargetById=941100;ARGS:content,\
     ctl:ruleRemoveTargetById=941160;ARGS:content,\
     ctl:ruleRemoveTargetById=941180;ARGS:content,\
     ctl:ruleRemoveTargetById=941140;ARGS:content,\
     ctl:ruleRemoveTargetById=942100;ARGS:content,\
     ctl:ruleRemoveTargetById=942110;ARGS:content,\
     ctl:ruleRemoveTargetById=932230;ARGS:content,\
     ctl:ruleRemoveTargetById=932235;ARGS:content,\
     ctl:ruleRemoveTargetById=932250;ARGS:content,\
     ctl:ruleRemoveTargetById=932260;ARGS:content,\
     ctl:ruleRemoveTargetById=941100;ARGS:source,\
     ctl:ruleRemoveTargetById=941160;ARGS:source,\
     ctl:ruleRemoveTargetById=942100;ARGS:source,\
     ctl:ruleRemoveTargetById=942110;ARGS:source,\
     ctl:ruleRemoveTargetById=941100;REQUEST_BODY,\
     ctl:ruleRemoveTargetById=941140;REQUEST_BODY,\
     ctl:ruleRemoveTargetById=941160;REQUEST_BODY,\
     ctl:ruleRemoveTargetById=941180;REQUEST_BODY,\
     ctl:ruleRemoveTargetById=942100;REQUEST_BODY,\
     ctl:ruleRemoveTargetById=942110;REQUEST_BODY,\
     ctl:ruleRemoveTargetById=932230;REQUEST_BODY,\
     ctl:ruleRemoveTargetById=932235;REQUEST_BODY,\
     ctl:ruleRemoveTargetById=932250;REQUEST_BODY,\
     ctl:ruleRemoveTargetById=932260;REQUEST_BODY"

# index.php?rest_route=/wp/v2/... form
SecRule REQUEST_URI "@streq /index.php" \
  "id:1100211,phase:2,pass,nolog,chain"
  SecRule QUERY_STRING "@rx (^|&)rest_route=%2Fwp%2Fv2%2F(templates|template\-parts)(%2F|&|$)" "t:none,chain"
  SecRule REQUEST_METHOD "@pm POST PUT PATCH" "t:none,chain"
    SecRule &REQUEST_HEADERS:Content-Type "@ge 1" "t:none,\
     ctl:ruleRemoveTargetById=941100;ARGS:content,\
     ctl:ruleRemoveTargetById=941160;ARGS:content,\
     ctl:ruleRemoveTargetById=941180;ARGS:content,\
     ctl:ruleRemoveTargetById=941140;ARGS:content,\
     ctl:ruleRemoveTargetById=942100;ARGS:content,\
     ctl:ruleRemoveTargetById=942110;ARGS:content,\
     ctl:ruleRemoveTargetById=932230;ARGS:content,\
     ctl:ruleRemoveTargetById=932235;ARGS:content,\
     ctl:ruleRemoveTargetById=932250;ARGS:content,\
     ctl:ruleRemoveTargetById=932260;ARGS:content,\
     ctl:ruleRemoveTargetById=941100;ARGS:source,\
     ctl:ruleRemoveTargetById=941160;ARGS:source,\
     ctl:ruleRemoveTargetById=942100;ARGS:source,\
     ctl:ruleRemoveTargetById=942110;ARGS:source,\
     ctl:ruleRemoveTargetById=941100;REQUEST_BODY,\
     ctl:ruleRemoveTargetById=941140;REQUEST_BODY,\
     ctl:ruleRemoveTargetById=941160;REQUEST_BODY,\
     ctl:ruleRemoveTargetById=941180;REQUEST_BODY,\
     ctl:ruleRemoveTargetById=942100;REQUEST_BODY,\
     ctl:ruleRemoveTargetById=942110;REQUEST_BODY,\
     ctl:ruleRemoveTargetById=932230;REQUEST_BODY,\
     ctl:ruleRemoveTargetById=932235;REQUEST_BODY,\
     ctl:ruleRemoveTargetById=932250;REQUEST_BODY,\
     ctl:ruleRemoveTargetById=932260;REQUEST_BODY"

# =====================================================================
# End of whitelist
# =====================================================================
# Or, if you prefer to keep engine ON but relax common false positives:
SecRule REQUEST_HEADERS:User-Agent "@rx \b(GPTBot|ChatGPT-User)\b" \
  "id:1300002,phase:1,pass,nolog,\
   ctl:ruleRemoveById=941100,\
   ctl:ruleRemoveById=941160,\
   ctl:ruleRemoveById=942100,\
   ctl:ruleRemoveById=942110"