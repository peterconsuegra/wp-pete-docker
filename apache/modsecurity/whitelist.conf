# =====================================================================
# Pete Panel – ModSecurity whitelist (balanced)
#   - Keep ModSecurity ON
#   - Surgical removals for WordPress/Woo basics
#   - Option B: remove OWASP CRS tags only for authenticated WRITE
#     requests on admin/REST scopes (safer than engine OFF)
# =====================================================================

###############################################################################
# GLOBAL: If WordPress user is authenticated, disable ModSecurity completely
# Triggers if any of: wordpress_logged_in_* cookie, X-WP-Nonce header, or Authorization
###############################################################################

###############################################################################
# SAFER: Only disable engine for authenticated admin/REST scopes
###############################################################################

# Auth signals
SecRule REQUEST_COOKIES_NAMES "@rx ^wordpress_logged_in_" \
  "id:701000,phase:1,pass,nolog,setvar:tx.wp_auth=1"
SecRule REQUEST_HEADERS:X-WP-Nonce "!@streq ''" \
  "id:701001,phase:1,pass,nolog,setvar:tx.wp_auth=1"
SecRule REQUEST_HEADERS:Authorization "^(?:Basic|Bearer)\\s" \
  "id:701002,phase:1,pass,nolog,setvar:tx.wp_auth=1"

# Scope: wp-admin/*
SecRule TX:wp_auth "@eq 1" \
  "id:701010,phase:1,pass,nolog,chain"
  SecRule REQUEST_URI "@rx ^/wp-admin/" \
    "t:none,ctl:requestBodyAccess=Off,ctl:ruleEngine=Off"

# Scope: /wp-json/*
SecRule TX:wp_auth "@eq 1" \
  "id:701011,phase:1,pass,nolog,chain"
  SecRule REQUEST_URI "@rx ^/wp-json/" \
    "t:none,ctl:requestBodyAccess=Off,ctl:ruleEngine=Off"

# Scope: index.php?rest_route=...
SecRule TX:wp_auth "@eq 1" \
  "id:701012,phase:1,pass,nolog,chain"
  SecRule REQUEST_BASENAME "@streq index.php" "t:none,chain"
  SecRule QUERY_STRING "@contains rest_route=" \
    "t:none,ctl:requestBodyAccess=Off,ctl:ruleEngine=Off"

# Allow methods beyond defaults (Woo/REST often use more than GET/POST)
SecAction \
 "id:1000112,phase:1,pass,nolog,t:none,setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT PATCH DELETE'"

###############################################################################
# 3) PETE PANEL INTERNAL PATHS (ENGINE OFF – SAFE, LOCAL ADMIN ONLY)
###############################################################################
SecRule REQUEST_URI "@beginsWith /admin/phpinfo"          "id:1000002,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /admin/phpinfo/view"     "id:1000003,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /validate-pete"          "id:1000004,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /pete_plugins_install"   "id:1000005,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /pete_update"            "id:1000006,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /update_post"            "id:1000007,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /phpmyadmin"             "id:1000008,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /phpmyinfo"              "id:1000009,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "^/app[0-9]+/update_post$"            "id:1000010,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /internal-certbot"       "id:1000011,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /internal-reload"        "id:1000012,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /pete_plugins"           "id:1000013,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /oupdates"               "id:1000014,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /wp_plugins"             "id:1000015,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /pete_installers"        "id:1000016,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /wp_global_options"      "id:1000017,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /validate_site_json"     "id:1000018,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /wp-json/pete/v1"        "id:1000019,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /plugins"                "id:1000020,phase:1,pass,nolog,ctl:ruleEngine=Off"


###############################################################################
# 4) WooCommerce / WordPress – Known safe exceptions
###############################################################################

# 4.1 Woo AJAX (front-end): fix common FPs incl. PHP inj (933150), XSS (941100/941160), SQLi (942100/942430)
SecRule &ARGS:wc-ajax "@eq 1" \
  "id:701100,phase:1,pass,nolog,chain,t:none"
  SecRule ARGS:wc-ajax "@rx ^(update_order_review|checkout|get_refreshed_fragments|apply_coupon|remove_coupon|add_to_cart|wc_stripe_verify_intent|wc_stripe_prepare_order)$" \
    "t:none, \
     ctl:ruleRemoveById=933150, \
     ctl:ruleRemoveById=941100,ctl:ruleRemoveById=941160, \
     ctl:ruleRemoveById=942100,ctl:ruleRemoveById=942430"

# Extra pin just for checkout (often noisier payloads)
SecRule ARGS:wc-ajax "@streq checkout" \
  "id:701101,phase:1,pass,nolog,ctl:ruleRemoveById=933150"

# 4.2 admin-ajax.php (front-end use by themes/plugins): scope by `action`
SecRule REQUEST_BASENAME "@streq admin-ajax.php" \
  "id:701110,phase:1,pass,nolog,chain"
  SecRule ARGS:action "@rx ^(woocommerce_add_variation|woocommerce_save_attributes|woocommerce_feature_product|woocommerce_json_search.*)$" \
    "t:none,ctl:ruleRemoveById=933150,ctl:ruleRemoveById=941100,ctl:ruleRemoveById=941160"

# 4.3 WordPress uploads (admin async upload strictness)
SecRule REQUEST_URI "@rx ^/wp-admin/async-upload\\.php$" \
  "id:701120,phase:1,pass,nolog,ctl:ruleRemoveById=920420,ctl:ruleRemoveById=920440"

# 4.4 Woo REST (public writes / checkout blocks / subscriptions)
SecRule REQUEST_URI "@rx ^/wp-json/wc/" \
 "id:701130,phase:1,pass,nolog, \
  ctl:ruleRemoveById=933150, \
  ctl:ruleRemoveById=941100,ctl:ruleRemoveById=941160, \
  ctl:ruleRemoveById=942100,ctl:ruleRemoveById=942430"

# 4.5 Payment gateway callbacks (wc-api=..., REST webhooks)
# Legacy wc-api=... callbacks (Stripe, PayPal, etc.) – match by argument, not URI
SecRule &ARGS:wc-api "@eq 1" \
  "id:701140,phase:1,pass,nolog,chain"
  SecRule ARGS:wc-api "@rx ^(WC_Gateway_Stripe|WC_Gateway_Paypal|wc_stripe|wc_gateway_stripe|paypal|ppcp_ipn)$" \
    "t:none, \
     ctl:ruleEngine=On, \
     ctl:ruleRemoveById=933150, \
     ctl:ruleRemoveById=941100,ctl:ruleRemoveById=941160, \
     ctl:ruleRemoveById=942100,ctl:ruleRemoveById=942430, \
     ctl:ruleRemoveById=920272,ctl:ruleRemoveById=920273"

# Example: strict OFF for a very specific Stripe REST webhook path (adjust to your plugin route)
# SecRule REQUEST_URI "@rx ^/wp-json/wc-stripe/v1/webhook$" \
#  "id:701141,phase:1,pass,nolog,ctl:ruleEngine=Off"

# 4.6 Add-to-cart GET/POST where attributes/ids look “SQL/XSS-like”
SecRule &ARGS:add-to-cart "@eq 1" \
 "id:701150,phase:1,pass,nolog, \
  ctl:ruleRemoveById=941100,ctl:ruleRemoveById=941160, \
  ctl:ruleRemoveById=942100,ctl:ruleRemoveById=942430"

###############################################################################
# 5) Your earlier targeted fix for the checkout FP (kept for clarity)
###############################################################################
# Minimal fix for /?wc-ajax=update_order_review tripping 933150
SecRule &ARGS:wc-ajax "@eq 1" \
  "id:701090,phase:1,pass,nolog,chain,t:none"
  SecRule ARGS:wc-ajax "@rx ^(update_order_review|checkout|apply_coupon|remove_coupon|get_refreshed_fragments|add_to_cart)$" \
    "t:none,ctl:ruleRemoveById=933150"
SecRule ARGS:wc-ajax "@streq checkout" \
  "id:701091,phase:1,pass,nolog,ctl:ruleRemoveById=933150"


###############################################################################
# 4.7 WooCommerce Checkout – relax noisy CRS rules for checkout flows
###############################################################################

# Flag: wc-ajax=checkout
SecRule &ARGS:wc-ajax "@eq 1" \
  "id:701160,phase:1,pass,nolog,chain,t:none"
  SecRule ARGS:wc-ajax "@streq checkout" \
    "t:none,setvar:tx.is_woo_checkout=1"

# Flag: classic /checkout URL
SecRule REQUEST_URI "@rx ^/checkout/?$" \
  "id:701161,phase:1,pass,nolog,setvar:tx.is_woo_checkout=1"

# Flag: Woo Blocks store API (cart + checkout)
SecRule REQUEST_URI "@rx ^/wp-json/wc/store/(cart|checkout)" \
  "id:701162,phase:1,pass,nolog,setvar:tx.is_woo_checkout=1"

# Relax CRS for any request marked as checkout
SecRule TX:is_woo_checkout "@eq 1" \
  "id:701163,phase:1,pass,nolog, \
   ctl:ruleRemoveById=933150,ctl:ruleRemoveById=933160, \
   ctl:ruleRemoveById=941100,ctl:ruleRemoveById=941160, \
   ctl:ruleRemoveById=942100,ctl:ruleRemoveById=942110,ctl:ruleRemoveById=942190, \
   ctl:ruleRemoveById=920272,ctl:ruleRemoveById=920273"


###############################################################################
# 4.8 WooCommerce Checkout – country selection (update_order_review)
#      When the user changes billing/shipping country, Woo calls:
#      /?wc-ajax=update_order_review with billing_country / shipping_country
###############################################################################

# Flag requests that are update_order_review AND touch country fields
SecRule &ARGS:wc-ajax "@eq 1" \
  "id:701170,phase:1,pass,nolog,chain,t:none"
  SecRule ARGS:wc-ajax "@streq update_order_review" "chain,t:none"
  SecRule ARGS_NAMES "@rx ^(billing_country|shipping_country)$" \
    "t:none,setvar:tx.is_woo_checkout_country=1"

# Relax noisy CRS rules just for those country-change calls
SecRule TX:is_woo_checkout_country "@eq 1" \
  "id:701171,phase:1,pass,nolog, \
   ctl:ruleRemoveById=933150,ctl:ruleRemoveById=933160, \
   ctl:ruleRemoveById=941100,ctl:ruleRemoveById=941160, \
   ctl:ruleRemoveById=942100,ctl:ruleRemoveById=942110,ctl:ruleRemoveById=942190, \
   ctl:ruleRemoveById=920272,ctl:ruleRemoveById=920273"